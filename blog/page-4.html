<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <title>Doug Bell</title>
        <style type="text/css">
            article > hgroup > h1,
            main > hgroup > h1
            {
                border-bottom: 4px solid #045578;
            }
            header aside {
                margin-top: 0;
                font-size: 12pt;
            }
            nav#tags h1 {
                font-size: 14pt;
            }
        </style>
    </head>
    <body>
        <header>
            <nav class="navbar navbar-default navbar-static-top" role="navigation">
                <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#top-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Doug Bell</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="/index.html">Blog</a></li>
                            <li><a href="/presentations.html">Presentations</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <div class="main container">
            
<div class="row">

    <div class="col-md-9">
        <main>
            <article>
                <header>
                    <h1><a href="/blog/2012/03/20/adventures-in-debugging-c-xs-2-debugging-boogaloo.html">Adventures in Debugging C/XS 2: Debugging Boogaloo</a></h1>
                    <aside>
                        <p><time datetime="2012-03-20">
                            Posted on 2012-03-20
                        </time>
                        by preaction</p>
                    </aside>
                </header>
                <p>... or "Ask Not To Whom The Pointer Points, It Points To Thee."</p>

<p>TL;DR: A pointer is not a reference. A pointer knows nothing about the data
being pointed to. Returning multiple values requires actual work.</p>

<p>Everything went wrong when I wanted a string with a <code>NUL</code> character inside it.
C strings are not Perl scalars, they don't know how long they are. So to mark
the end of a string, C uses the <code>NUL</code> character, <code>\0</code>. The <code>strcpy</code> function will
copy to your destination until the first <code>\0</code> from your source. When you want to
have a string with a <code>\0</code> inside of it that does not mark the end of the string,
you need to know exactly how long the string is. This is not difficult to do,
but you also have to return that length from the function that creates your
string.</p>

<p>C functions do not have more than one return value.</p>

<pre><code>(char* buffer, int bufferSize) = get_string_with_nuls();
// You thought it could be that easy?
</code></pre>

<p>So in order for your function to result in more than one value, you have to
pass in references to be used to fill in with actual values.</p>

<pre><code>char* buffer;
int bufferSize = get_string_with_nuls( buffer );
// C programmers will already know what I did wrong here
</code></pre>

<p>Thinking like a Perl programmer, I thought I could just pass in the pointer to
the function and the function could fill it with data. Two problems:</p>

<ol>
<li>I passed in the pointer itself, not a reference to the pointer: <code>&amp;buffer</code></li>
<li>I did not initialize the pointer to anything.</li>
</ol>

<p>A more correct way would be:</p>

<pre><code>char* buffer = malloc( 128 * sizeof( char ) );
int bufferSize = get_string_with_nuls( &amp;buffer );
</code></pre>

<p>But this suffers from another problem: I have to know beforehand how big my
string is going to be and allocate that much memory beforehand.</p>

<p>The way I ended up succeeding was:</p>

<pre><code>int bufferSize;
char* buffer = get_string_with_nuls( &amp;bufferSize );
</code></pre>

<p>This way, <code>get_string_with_nuls</code> can handle the <code>malloc</code> with exactly the correct
size and give it to me. I don't have to guess at a size beforehand.</p>

<p>Of course, a struct could do this better, or since I'm actually in C++, an
object. I'll be planning a new API as soon as I confirm this one actually
works and has proper tests (written in Perl, of course).</p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/11/16/adventures-in-debugging-c-xs.html">Adventures in Debugging C/XS</a></h1>
                    <aside>
                        <p><time datetime="2011-11-16">
                            Posted on 2011-11-16
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/11/adventures-in-debugging-cxs.html">
                                <em>Adventures in Debugging C/XS</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>... or Why A Good Perl Developer Is Not Automatically A Good C Developer, the
Story of C Programming via Google.</p>

<p>My tests failed, but only sometimes. I was building an XS module to interface
with a C wrapper around a C++ library (wrapper unnecessary? probably). <code>make
test</code> was failing with exit code 11. Some quick searching revealed that I had
an intermittent segfault. Calling a function <code>as_xml</code> would fail with a SEGV in
<code>strlen()</code>. This only happened in perl after <code>as_xml</code> when perl was making a SV
out of the return value. This also only mainly happened during <code>make test</code>.
Doing <code>prove</code> myself would succeed 19 times out of 20, where make test would
fail 19 times out of 20. Worse, my C test program would never fail at all.</p>

<hr />

<p>I changed everything I could think of: Using a debugging perl and keeping debug
symbols in my C library and XS module made the failures happen less frequently
(making debugging ever more frustrating). perlbrew was a big help here, letting
me switch between different versions of perl, debugging perl, threaded perl,
and combinations thereof.</p>

<p>After playing with GDB (once again succeeding 19 times out of 20), I gave up
and searched the web. I found <a href="http://bit.ly/vwnMbb">the same mailing list
thread</a> multiple times, and read it multiple times, not
coming up with anything that was relevant to my situation.</p>

<p>Until I read the thread again after another frustrating half-hour with GDB: I
had forgotten to put a prototype in the .h file, causing the char* pointer
being returned to be treated as an int. On my 64-bit system, this causes
segfaults. The compiler was warning me of this, "<tt>warning: initialization
makes pointer from integer without a cast</tt>", but I didn't understand the
warning (and the web was not helpful on that one).</p>

<p>Adding the function prototype to the C wrapper header and recompiling fixed the
problem.</p>

<p>And that is why I need to learn a lot more about C. Function prototypes?
Header files? Why are those necessary (I'm asking rhetorically, of course)?
Heap and stack? Might as well be herp and derp.</p>

<p>Lesson reinforced: Depth of knowledge does not equal breadth of knowledge.</p>

<p>Also, having IRC at work might have saved me a few hours of hassle.</p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/05/20/webgui-8-status-report.html">WebGUI 8 Status Report</a></h1>
                    <aside>
                        <p><time datetime="2011-05-20">
                            Posted on 2011-05-20
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/05/webgui-8-status-report.html">
                                <em>WebGUI 8 Status Report</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>A major milestone in WebGUI 8 development was reached this week: A dry-run of
the WebGUI 8 upgrade was successfully run against the plainblack.com database.
This means the only thing remaining from releasing an alpha 8.0.0 is updating
all the custom code on <a href="http://plainblack.com">http://plainblack.com</a> and
<a href="http://webgui.org">http://webgui.org</a>. As always, plainblack.com and
webgui.org will be the first sites running the latest bleeding-edge version of
WebGUI (unless one of you wants to beat me to the punch).</p>

<p>This month, I also gave a presentation to <a href="http://madmongers.org">Madison.PM</a>
about <a href="http://preaction.github.com/WebGUI/8-apps.html">building applications in WebGUI
8</a>, a quick introduction to
Assets and an overview of the most important changes to how they work. The
slides are available at
<a href="http://preaction.github.com/">http://preaction.github.com/</a> and the code
samples are linked at the end.</p>

<p>On an unrelated topic, I really enjoyed using
<a href="http://meyerweb.com/eric/tools/s5/">S5</a> to build my slides,
<a href="http://shjs.sourceforge.net/">SHJS</a> to highlight the code inside, and <a href="http://pages.github.com/">Github
Pages</a> to host the whole thing. I plan on doing the
same for all my presentations: They look good, readable without a special
program, editable without a special program, anyone can fork and update my
presentations, and they're served by a nice, fast, free host.</p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/03/09/chi-saves-the-day.html">CHI Saves The Day</a></h1>
                    <aside>
                        <p><time datetime="2011-03-09">
                            Posted on 2011-03-09
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/03/chi-saves-the-day.html">
                                <em>CHI Saves The Day</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <h2>The Server Is Down</h2>

<ol>
<li>No it isn't, I didn't get paged.</li>
<li>Wait a minute, why didn't I get paged?</li>
<li>FUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU--</li>
<li>CHALLENGE ACCEPTED</li>
</ol>

<h2>Diagnosis</h2>

<p>The client reported that the site sometimes took more than a minute to load.
Doesn't respond very slowly to me, and the pager is only primed to ping me if
there is a sustained downtime (hiccups are not something I want to wake up for
every night at 3:00am).</p>

<p>Strangely, load hovered around 7 most of the time, only spiking to 13 every
few minutes. With a 16-core processor, this was well within operating
parameters, if just a little worrisome. Nothing in the log files.</p>

<p>Oops, now I get a slow page load. Takes 30 seconds to load a page. Refresh
again, and the page loads just fine. Clear browser cache, and the page still
loads just fine.</p>

<p>top kept MySQL at the top of the CPU list. Not surprising, as this server is
the master database server for a two node cluster. So I keep an eye on top as
I poll mysql for its process list.</p>

<p>A pattern emerges: The load spikes and server goes unresponsive when this happens:</p>

<p><img src="/blog/images/chi-saves-the-day/Screen shot 2011-03-08 at 10.43.37 PM.png"/></p>

<p>This table shows 12 different processes are trying to update the same cache
location (process ID 2-3, 5-8, 10, 12-13, 18, 23, and 26). Because of MyISAM's
table-level lock, any request to get from the cache has to wait for 12 REPLACE
INTO requests to complete. They've already taken 1 second, if each replace
takes 2 seconds, that's 24 seconds of non-responsive website.</p>

<p>These 12 processes all saw that the cache item had expired and are trying to
update it. This is called a "cache stampede". Only one of them needs to update
the cache, the rest are just wasting resources. Worse, they're doing all the
work to update the cache, which is much more expensive than getting the value
from the cache. If it's expensive enough, the site goes down hard.</p>

<h2>Management</h2>

<p>How can we stop the cache stampede? One way is to mildly randomize the actual
expiration date when checking if the cache is expired:</p>

<pre><code>sub is_expired {
    my ( $self, $key ) = @_;
    my $expires = $self-&gt;get_expires( $key );
    # Randomize the expiration by up to 5% +/-
    # by first removing 5% and then adding 0-10%
    $expires = $expires - ( $expires * 0.05 ) + ( $expires * 0.10 * rand );
    # Compare against now
    return $expires &gt; time;
}
</code></pre>

<p>In this very simple case, if you are within 5% of the expiration time, you
have a chance to have an expired cache item. The chance grows as time passes,
reaching 50% at the actual expiration time, and 100% at 5% past the expiration
time.</p>

<p>Rather than add this expiration variance to our custom database cache, I
instead opted to move this site over to CHI, which has this protection
built-in.</p>

<pre><code>my $cache   = CHI-&gt;new(
    driver              =&gt; 'DBI',
    namespace           =&gt; 'localhost',
    dbh                 =&gt; $dbh,
    expires_variance    =&gt; '0.10',
);
</code></pre>

<p>This stops the cache stampede, but we're still hitting the database a lot.
Remember we have two web nodes hitting one database node. The fewer database
hits we make, the better performance we can get without having to ask for more
hardware from the client (which takes time, and forms, and more forms, and
meetings, and forms, and more meetings, and probably some forms).</p>

<p>Because this is a distributed system, we need a distributed, synchronized
cache. We cannot use memcached, as WebGUI 7.x does not support it (but WebGUI
8 does). So for now we must use the database as our synchronized cache, but
what if we put a faster, local cache in front of the slower, synchronized
cache?</p>

<p>CHI has an awesome way to do this: Add an l1_cache</p>

<pre><code>my $cache   = CHI-&gt;new(
    driver              =&gt; 'DBI',
    namespace           =&gt; 'localhost',
    dbh                 =&gt; $dbh,
    expires_variance    =&gt; '0.10',
    l1_cache            =&gt; {
        driver      =&gt; 'FastMmap',
        root_dir    =&gt; '/tmp/cache',
    },
);
</code></pre>

<p>Now we're using FastMmap to share an in-memory cache between our web
processes, and if the L1 cache is expired or missing, we look for content from
the DBI cache. If that cache is missing or expired, we have a cache miss and
have to recompute the value.</p>

<h2>Hurdles</h2>

<p>I had to install the DB tables myself, which was not difficult, just
undocumented (bug report filed). MySQL only allows a 1000-byte key, and the
CHI::Driver::DBI tries to create a 600-character key. This is fine in the
Latin-1 charset, but MySQL complains if you're using UTF-8 by default.</p>

<p>The driver also tries to create a TEXT field to hold the cache value, but
MySQL expects a text field to hold characters in a known character set. After
noticing that my cache values were empty, I changed to a LONGBLOB.</p>

<p>The full create table statements are below:</p>

<pre><code>-- primary cache table: chi_&lt;namespace&gt; --
CREATE TABLE IF NOT EXISTS `chi_localhost` (
    `key` VARCHAR(255),
    `value` LONGBLOB,
    PRIMARY KEY ( `key` )
);

-- CHI metacache table --
CREATE TABLE IF NOT EXISTS `chi__CHI_METACACHE` (
    `key` VARCHAR(255),
    `value` LONGBLOB,
    PRIMARY KEY ( `key` )
);
</code></pre>

<h2>Results</h2>

<p><img src="/blog/images/chi-saves-the-day/Screen shot 2011-03-08 at 10.20.55 PM.png" /></p>

<p>The server is stable again! Spikes do not turn into out-of-control loads and
unresponsive server. We'll see how things go tomorrow during normal business
hours (the peak time for this site), but right now it looks like CHI has saved
the day!</p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/03/05/whats-new-in-webgui-8.0-5-asset-helpers.html">What's New in WebGUI 8.0 #5 - Asset Helpers</a></h1>
                    <aside>
                        <p><time datetime="2011-03-05">
                            Posted on 2011-03-05
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/03/whats-new-in-webgui-80-5---asset-helpers.html">
                                <em>What's New in WebGUI 8.0 #5 - Asset Helpers</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>By far the biggest change we've made in WebGUI 8 is the new Admin Console.
Though parts of it may look familiar, it has been completely rewritten from
the ground up to be a flexible, extensible, responsive JavaScript application
making calls to JSON services in Perl.</p>

<p>I could talk about how to use the admin interface, but I don't think that's
why you would read this blog, so instead I'm going to talk about how you can add functionality to it.</p>

<hr />

<h2>Asset Services</h2>

<p>Since Assets are the basic unit of both application and content in WebGUI,
much of the Admin Console is spent interacting with Assets. It does so by
calling out to Asset Helpers.</p>

<p>By default, every asset has a helper to Cut, Copy, Duplicate, Delete, and
more. When a helper gets called, it returns a JSON data structure explaining
to the Admin Console what to do next.</p>

<p>We can simply show the user a message:</p>

<pre><code>message     =&gt; 'The work is done, here's what happened.'
error       =&gt; 'Something went wrong.'
</code></pre>

<p>Or we can open up new dialogs or tabs to allow the user to give us more data:</p>

<pre><code>openDialog  =&gt; '/helper/get_input'
openTab     =&gt; '/helper/get_input'
</code></pre>

<p>We can let the user know their command is running in a forked process:</p>

<pre><code>forkId      =&gt; '...' # GUID for WebGUI::Fork object
</code></pre>

<p>We can even load and run any external JS file:</p>

<pre><code>scriptFile  =&gt; '/extras/newscript.js',  # Load a new script file
scriptFunc  =&gt; 'myFunction',            # Call a function in that script
scriptArgs  =&gt; [ "arg1", "arg2", ],     # Pass some arguments to that func
</code></pre>

<p>To write an Asset Helper, we inherit from WebGUI::AssetHelper and override the
process() method to send back one of the message types from above.</p>

<pre><code>package MyHelper;
use base 'WebGUI::AssetHelper';

sub process {
    my ( $self ) = @_;

    return { error =&gt; 'Cry Havoc!' } if !$self-&gt;asset-&gt;canEdit;

    # Do some work

    return { message =&gt; 'Work is done!' };
}
</code></pre>

<p>If our Asset Helper needs to get some input from the user, we can open a
dialog. Like most everything in WebGUI, Asset Helpers can also have www_
methods.</p>

<pre><code>package MyFormHelper;
use base 'WebGUI::AssetHelper';

sub process {
    my ( $self ) = @_;
    my $url = $self-&gt;getUrl( "showForm" );
    return { openDialog =&gt; $url };
}

sub www_showForm {
    my ( $self ) = @_;
    my $form    = $self-&gt;getForm( 'processForm' ); # WebGUI::FormBuilder
    $form-&gt;addField( "text", name =&gt; 'why' );
    return $form-&gt;toHtml;
}

sub www_processForm {
    my ( $self ) = @_;
    my $input = $self-&gt;session-&gt;form-&gt;get( 'why' ); # input from the form
    return { message =&gt; $input }; # Why not?
}
</code></pre>

<p>But our asset helpers are not only useful inside of the Admin Console. Because
they're all built on a simple JSON API, you can call them from anywhere. For
example, the Asset Helper to resize and rotate images could be used by anyone
with edit privileges to the Image.</p>

<p>Because we already have these Asset Helpers, the new Asset Manager (now called 
the Tree view) uses them to perform all of its tasks. This means, again, more
code reuse and less code in WebGUI.</p>

<p>Side note: I love deleting code much more than writing it.</p>

<h2>Adding Helpers</h2>

<p>What would a plugin point be without a way to override what already exists? In
our case, if you want another helper to handle the "cut" operation, you can
make it happen.</p>

<p>If you have your own asset, you can override the getHelpers method, which
returns a hashref of helper descriptions:</p>

<pre><code>package MyAsset;

around getHelpers =&gt; sub {
    my ( $orig, $self ) = @_;
    my $helpers = $self-&gt;$orig;
    $helpers-&gt;{ "cut" } = {
        className   =&gt; 'MyCutHelper',
        label       =&gt; 'SuperCuts',
    };
    return $helpers;
};
</code></pre>

<p>Or if you don't want to edit the asset's code, you could add your helpers to
the configuration file:</p>

<pre><code>{
    "assets" : {
        "WebGUI::Asset::Snippet" : {
            "helpers" : {
                "cut" : {
                    "className" : "MyCutHelper",
                    "label"     : "SuperCuts"
                }
            }
        }
    }
}
</code></pre>

<p>Side Note: Deep data-structure is deep.</p>

<p>A Helper doesn't have to be its own class, it could be any URL at all:</p>

<pre><code>$helpers-&gt;{ "edit" } = {
    url     =&gt; './edit',
    label   =&gt; 'Edit',
};
</code></pre>

<p>So Asset Helpers are the new way to add related tasks to your assets. Come
back next time when I introduce WebGUI::FormBuilder.</p>

            </article>
        </main>
        <ul class="pager">
            <li class="previous ">
                <a rel="next" href="/blog/page-5.html">&larr; Older</a>
            </li>
            <li class="next ">
                <a rel="prev" href="/blog/page-3.html">Newer &rarr;</a>
            </li>
        </ul>
    </div>

    <div class="col-md-3">
        <nav id="tags">
            <h1>Tags</h1>
            <ul class="list-inline">
                <li><a href="/blog/tag/chicago.pm/index.html">chicago.pm</a></li>
                <li><a href="/blog/tag/error/index.html">error</a></li>
                <li><a href="/blog/tag/git/index.html">git</a></li>
                <li><a href="/blog/tag/moose/index.html">moose</a></li>
                <li><a href="/blog/tag/mysql/index.html">mysql</a></li>
                <li><a href="/blog/tag/perl/index.html">perl</a></li>
                <li><a href="/blog/tag/rants/index.html">rants</a></li>
                <li><a href="/blog/tag/software/index.html">software</a></li>
                <li><a href="/blog/tag/webgui/index.html">webgui</a></li>
                <li><a href="/blog/tag/xs/index.html">xs</a></li>
            </ul>
        </nav>
    </div>

</div>

        </div>
    </body>
</html>
