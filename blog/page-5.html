<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap-theme.min.css" />
        <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <title>preaction</title>
        <style type="text/css">
            main header h1
            {
                border-bottom: 4px solid #045578;
            }
            header aside {
                margin-top: 0;
                font-size: 12pt;
            }
            .sidebar h1 {
                font-size: 14pt;
            }

            /** Add a line when using the "Continue reading..." link */
            section:target {
                padding-top: 0.5em;
                border-top: 4px solid #045578;
            }

            /** Don't allow <pre> to push too much */
            pre {
                max-width: 100%;
                overflow-x: scroll;
            }

            /** <code> is used for input and output, so let it wrap */
            code {
                white-space: normal;
            }

            .tags {
                float: right;
            }

            /**
             * Don't allow main content images to push things around
             */
            main img {
                max-width: 100%;
            }

        </style>
            <link rel="alternate" href="/blog/index.atom" type="application/atom+xml" />
            <link rel="alternate" href="/blog/index.rss" type="application/rss+xml" />
    </head>
    <body>
        <header>
            <nav class="navbar navbar-default navbar-static-top" role="navigation">
                <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#top-navbar-collapse-1">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">preaction</a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="top-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="/index.html">Blog</a></li>
                            <li><a href="/Statocles">Statocles</a></li>
                            <li><a href="/presentations.html">Presentations</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <div class="main container">
            
<div class="row">

    <div class="col-md-9">
        <main>
            <article>
                <header>
                    <h1><a href="/blog/2011/11/16/adventures-in-debugging-c-xs.html">Adventures in Debugging C/XS</a></h1>
                    <p class="tags">Tags:
                        <a href="/blog/tag/xs/index.html" rel="tag">xs</a>
                    </p>
                    <aside>
                        <p><time datetime="2011-11-16">
                            Posted on 2011-11-16
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/11/adventures-in-debugging-cxs.html">
                                <em>Adventures in Debugging C/XS</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>... or Why A Good Perl Developer Is Not Automatically A Good C Developer, the
Story of C Programming via Google.</p>

<p>My tests failed, but only sometimes. I was building an XS module to interface
with a C wrapper around a C++ library (wrapper unnecessary? probably). <code>make
test</code> was failing with exit code 11. Some quick searching revealed that I had
an intermittent segfault. Calling a function <code>as_xml</code> would fail with a SEGV in
<code>strlen()</code>. This only happened in perl after <code>as_xml</code> when perl was making a SV
out of the return value. This also only mainly happened during <code>make test</code>.
Doing <code>prove</code> myself would succeed 19 times out of 20, where make test would
fail 19 times out of 20. Worse, my C test program would never fail at all.</p>

                    <p><a href="/blog/2011/11/16/adventures-in-debugging-c-xs.html#section-2">Continue reading Adventures in Debugging C/XS...</a></p>
            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/05/20/webgui-8-status-report.html">WebGUI 8 Status Report</a></h1>
                    <p class="tags">Tags:
                        <a href="/blog/tag/webgui/index.html" rel="tag">webgui</a>
                    </p>
                    <aside>
                        <p><time datetime="2011-05-20">
                            Posted on 2011-05-20
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/05/webgui-8-status-report.html">
                                <em>WebGUI 8 Status Report</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>A major milestone in WebGUI 8 development was reached this week: A dry-run of
the WebGUI 8 upgrade was successfully run against the plainblack.com database.
This means the only thing remaining from releasing an alpha 8.0.0 is updating
all the custom code on <a href="http://plainblack.com">http://plainblack.com</a> and
<a href="http://webgui.org">http://webgui.org</a>. As always, plainblack.com and
webgui.org will be the first sites running the latest bleeding-edge version of
WebGUI (unless one of you wants to beat me to the punch).</p>

<p>This month, I also gave a presentation to <a href="http://madmongers.org">Madison.PM</a>
about <a href="http://preaction.github.com/WebGUI/8-apps.html">building applications in WebGUI
8</a>, a quick introduction to
Assets and an overview of the most important changes to how they work. The
slides are available at
<a href="http://preaction.github.com/">http://preaction.github.com/</a> and the code
samples are linked at the end.</p>

<p>On an unrelated topic, I really enjoyed using
<a href="http://meyerweb.com/eric/tools/s5/">S5</a> to build my slides,
<a href="http://shjs.sourceforge.net/">SHJS</a> to highlight the code inside, and <a href="http://pages.github.com/">Github
Pages</a> to host the whole thing. I plan on doing the
same for all my presentations: They look good, readable without a special
program, editable without a special program, anyone can fork and update my
presentations, and they're served by a nice, fast, free host.</p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/03/09/chi-saves-the-day.html">CHI Saves The Day</a></h1>
                    <p class="tags">Tags:
                        <a href="/blog/tag/webgui/index.html" rel="tag">webgui</a>
                        <a href="/blog/tag/mysql/index.html" rel="tag">mysql</a>
                    </p>
                    <aside>
                        <p><time datetime="2011-03-09">
                            Posted on 2011-03-09
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/03/chi-saves-the-day.html">
                                <em>CHI Saves The Day</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <h2>The Server Is Down</h2>

<ol>
<li>No it isn't, I didn't get paged.</li>
<li>Wait a minute, why didn't I get paged?</li>
<li>FUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU--</li>
<li>CHALLENGE ACCEPTED</li>
</ol>

<h2>Diagnosis</h2>

<p>The client reported that the site sometimes took more than a minute to load.
Doesn't respond very slowly to me, and the pager is only primed to ping me if
there is a sustained downtime (hiccups are not something I want to wake up for
every night at 3:00am).</p>

<p>Strangely, load hovered around 7 most of the time, only spiking to 13 every
few minutes. With a 16-core processor, this was well within operating
parameters, if just a little worrisome. Nothing in the log files.</p>

<p>Oops, now I get a slow page load. Takes 30 seconds to load a page. Refresh
again, and the page loads just fine. Clear browser cache, and the page still
loads just fine.</p>

<p>top kept MySQL at the top of the CPU list. Not surprising, as this server is
the master database server for a two node cluster. So I keep an eye on top as
I poll mysql for its process list.</p>

<p>A pattern emerges: The load spikes and server goes unresponsive when this happens:</p>

<p><img src="/blog/images/chi-saves-the-day/Screen%20shot%202011-03-08%20at%2010.43.37%20PM.png" alt="" /></p>

<p>This table shows 12 different processes are trying to update the same cache
location (process ID 2-3, 5-8, 10, 12-13, 18, 23, and 26). Because of MyISAM's
table-level lock, any request to get from the cache has to wait for 12 REPLACE
INTO requests to complete. They've already taken 1 second, if each replace
takes 2 seconds, that's 24 seconds of non-responsive website.</p>

<p>These 12 processes all saw that the cache item had expired and are trying to
update it. This is called a "cache stampede". Only one of them needs to update
the cache, the rest are just wasting resources. Worse, they're doing all the
work to update the cache, which is much more expensive than getting the value
from the cache. If it's expensive enough, the site goes down hard.</p>

<h2>Management</h2>

<p>How can we stop the cache stampede? One way is to mildly randomize the actual
expiration date when checking if the cache is expired:</p>

<pre><code>sub is_expired {
    my ( $self, $key ) = @_;
    my $expires = $self-&gt;get_expires( $key );
    # Randomize the expiration by up to 5% +/-
    # by first removing 5% and then adding 0-10%
    $expires = $expires - ( $expires * 0.05 ) + ( $expires * 0.10 * rand );
    # Compare against now
    return $expires &gt; time;
}
</code></pre>

<p>In this very simple case, if you are within 5% of the expiration time, you
have a chance to have an expired cache item. The chance grows as time passes,
reaching 50% at the actual expiration time, and 100% at 5% past the expiration
time.</p>

<p>Rather than add this expiration variance to our custom database cache, I
instead opted to move this site over to CHI, which has this protection
built-in.</p>

<pre><code>my $cache   = CHI-&gt;new(
    driver              =&gt; 'DBI',
    namespace           =&gt; 'localhost',
    dbh                 =&gt; $dbh,
    expires_variance    =&gt; '0.10',
);
</code></pre>

<p>This stops the cache stampede, but we're still hitting the database a lot.
Remember we have two web nodes hitting one database node. The fewer database
hits we make, the better performance we can get without having to ask for more
hardware from the client (which takes time, and forms, and more forms, and
meetings, and forms, and more meetings, and probably some forms).</p>

<p>Because this is a distributed system, we need a distributed, synchronized
cache. We cannot use memcached, as WebGUI 7.x does not support it (but WebGUI
8 does). So for now we must use the database as our synchronized cache, but
what if we put a faster, local cache in front of the slower, synchronized
cache?</p>

<p>CHI has an awesome way to do this: Add an l1_cache</p>

<pre><code>my $cache   = CHI-&gt;new(
    driver              =&gt; 'DBI',
    namespace           =&gt; 'localhost',
    dbh                 =&gt; $dbh,
    expires_variance    =&gt; '0.10',
    l1_cache            =&gt; {
        driver      =&gt; 'FastMmap',
        root_dir    =&gt; '/tmp/cache',
    },
);
</code></pre>

<p>Now we're using FastMmap to share an in-memory cache between our web
processes, and if the L1 cache is expired or missing, we look for content from
the DBI cache. If that cache is missing or expired, we have a cache miss and
have to recompute the value.</p>

<h2>Hurdles</h2>

<p>I had to install the DB tables myself, which was not difficult, just
undocumented (bug report filed). MySQL only allows a 1000-byte key, and the
CHI::Driver::DBI tries to create a 600-character key. This is fine in the
Latin-1 charset, but MySQL complains if you're using UTF-8 by default.</p>

<p>The driver also tries to create a TEXT field to hold the cache value, but
MySQL expects a text field to hold characters in a known character set. After
noticing that my cache values were empty, I changed to a LONGBLOB.</p>

<p>The full create table statements are below:</p>

<pre><code>-- primary cache table: chi_&lt;namespace&gt; --
CREATE TABLE IF NOT EXISTS `chi_localhost` (
    `key` VARCHAR(255),
    `value` LONGBLOB,
    PRIMARY KEY ( `key` )
);

-- CHI metacache table --
CREATE TABLE IF NOT EXISTS `chi__CHI_METACACHE` (
    `key` VARCHAR(255),
    `value` LONGBLOB,
    PRIMARY KEY ( `key` )
);
</code></pre>

<h2>Results</h2>

<p><img src="/blog/images/chi-saves-the-day/Screen%20shot%202011-03-08%20at%2010.20.55%20PM.png" alt="" /></p>

<p>The server is stable again! Spikes do not turn into out-of-control loads and
unresponsive server. We'll see how things go tomorrow during normal business
hours (the peak time for this site), but right now it looks like CHI has saved
the day!</p>

            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/03/05/whats-new-in-webgui-8.0-5-asset-helpers.html">What's New in WebGUI 8.0 #5 - Asset Helpers</a></h1>
                    <p class="tags">Tags:
                        <a href="/blog/tag/webgui/index.html" rel="tag">webgui</a>
                    </p>
                    <aside>
                        <p><time datetime="2011-03-05">
                            Posted on 2011-03-05
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/03/whats-new-in-webgui-80-5---asset-helpers.html">
                                <em>What's New in WebGUI 8.0 #5 - Asset Helpers</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>By far the biggest change we've made in WebGUI 8 is the new Admin Console.
Though parts of it may look familiar, it has been completely rewritten from
the ground up to be a flexible, extensible, responsive JavaScript application
making calls to JSON services in Perl.</p>

<p>I could talk about how to use the admin interface, but I don't think that's
why you would read this blog, so instead I'm going to talk about how you can add functionality to it.</p>

                    <p><a href="/blog/2011/03/05/whats-new-in-webgui-8.0-5-asset-helpers.html#section-2">Continue reading What's New in WebGUI 8.0 #5 - Asset Helpers...</a></p>
            </article>
            <article>
                <header>
                    <h1><a href="/blog/2011/02/18/whats-new-in-webgui-8.0-4-chi-cache.html">What's New in WebGUI 8.0 #4 -- CHI Cache</a></h1>
                    <p class="tags">Tags:
                        <a href="/blog/tag/webgui/index.html" rel="tag">webgui</a>
                    </p>
                    <aside>
                        <p><time datetime="2011-02-18">
                            Posted on 2011-02-18
                        </time>
                        by preaction</p>
                    </aside>
                    <div class="alert alert-info">
                        <p>Originally posted as:</p>
                        <ul>
                            <li><a class="alert-link" href="http://blogs.perl.org/users/preaction/2011/02/whats-new-in-webgui-80-4----chi-cache.html">
                                <em>What's New in WebGUI 8.0 #4 -- CHI Cache</em> on blogs.perl.org.
                            </a></li>
                        </ul>
                    </div>
                </header>
                <p>Caching is a tricky business. Having just one kind of cache won't work, because
the production environment will greatly determine the most efficient caching
system. A distributed production environment would be best-served with a
distributed cache. A smaller, single-server environment could use a simple
shared memory cache.</p>

<p>Enter Jonathan Swartz's <a href="https://metacpan.org/pod/CHI">CHI</a> module, the greatest Perl module to provide a
unified caching interface. CHI is the DBI of caching: It presents an API, and
delegates to CHI::Driver modules to perform the heavy lifting. It
provides a layered caching system, allowing you to have a faster, more
volatile cache in front of a slower, more persistent cache. It also provides a
variable expiration time, preventing a "miss stampede" where all processes try
to recompute an expired cache item at the same time.</p>

<p>By integrating CHI cache into WebGUI, we have the ability to provide any
caching strategy that CHI can provide. We get Memcached, FastMmap, and DBI
drivers (and more drivers can be written).</p>

<p>I wrote a CHI cache driver for WebGUI 7.9 that we've been using on many of our
shared hosting servers. The performance increase using FastMmap through CHI 
over the old Storable+DBI cache module is dramatic: 2-5 times faster with
CHI and FastMmap.</p>

<h2>Using CHI in WebGUI</h2>

<p>The fewer wrappers that WebGUI has around CPAN modules we use, the less code I
have to write, and the more features will be available to our users without
having to change WebGUI to use them.</p>

<p>To that end, you can write a section of the configuration file that gets
passed directly to CHI->new. Some massaging occurs to make sure a DBI cache
driver gets the right $dbh, but otherwise you can fully configure CHI directly
from the WebGUI config file:</p>

<pre><code># The new default cache for WebGUI, FastMmap
{
     cache : {
         driver : 'FastMmap',
         root_dir : '/tmp/WebGUICache',
         expires_variance : 0.5
     }
 }

 # Set up a memcached cache with local memory in front
 {
     cache : {
         driver : 'Memcached::libmemcached',
         servers : [ '10.0.0.100:11211', '10.0.0.110:11211' ],
         l1_cache : {
            driver : 'Memory'
         }
     }
 }
</code></pre>

<p>When you want to use the cache in your code, you can get a CHI object with
$session->cache. CHI's interface is sufficiently simple, with some fun tricks:</p>

<pre><code>my $cache = $session-&gt;cache; # as read
my $value = $cache-&gt;get('cache_key');
if ( !$value ) {
    $value = compute_value();
    $cache-&gt;set( 'cache_key', $value );
}

# Combine get and set with intelligence
my $value = $cache-&gt;compute( 'cache_key', \&amp;compute_value );
</code></pre>

<h2>Future Plans</h2>

<p>With a single unified cache that performs well and layers like CHI, we can
take our current stow and scratch APIs and move them to the cache. In the case
of stow, we remove a redundant API. In the case of scratch, we remove database
hits.</p>

<p>We've also been exploring cache-only sessions, instead of updating the session
every time a page is requested, updating the cache only, flushing to the
database (or not). The fewer DB calls we make per page, the better performance
will be.</p>

<p>Special thanks go out to Jonathan Swartz for such a wonderful solution.</p>

<p>Stay tuned for next time when I explore our new Admin Interface. Lots of
pretty and screenshots!</p>

            </article>
        </main>
        <ul class="pager">
            <li class="previous ">
                <a rel="next" href="/blog/page-6.html">&larr; Older</a>
            </li>
            <li class="next ">
                <a rel="prev" href="/blog/page-4.html">Newer &rarr;</a>
            </li>
        </ul>
    </div>

    <div class="sidebar col-md-3">
        <h1>Tags</h1>
        <ul class="list-inline">
            <li><a href="/blog/tag/chicago.pm/index.html">chicago.pm</a></li>
            <li><a href="/blog/tag/error/index.html">error</a></li>
            <li><a href="/blog/tag/funny/index.html">funny</a></li>
            <li><a href="/blog/tag/git/index.html">git</a></li>
            <li><a href="/blog/tag/moose/index.html">moose</a></li>
            <li><a href="/blog/tag/mysql/index.html">mysql</a></li>
            <li><a href="/blog/tag/openbsd/index.html">openbsd</a></li>
            <li><a href="/blog/tag/perl/index.html">perl</a></li>
            <li><a href="/blog/tag/personal/index.html">personal</a></li>
            <li><a href="/blog/tag/rants/index.html">rants</a></li>
            <li><a href="/blog/tag/scripts/index.html">scripts</a></li>
            <li><a href="/blog/tag/software/index.html">software</a></li>
            <li><a href="/blog/tag/webgui/index.html">webgui</a></li>
            <li><a href="/blog/tag/xs/index.html">xs</a></li>
        </ul>
        <h1>Feeds</h1>
        <ul class="list-inline">
            <li>
                <a href="/blog/index.atom" rel="alternate" type="application/atom+xml">
                    Atom
                </a>
            </li>
            <li>
                <a href="/blog/index.rss" rel="alternate" type="application/rss+xml">
                    RSS
                </a>
            </li>
        </ul>
    </div>

</div>

        </div>
    </body>
</html>
